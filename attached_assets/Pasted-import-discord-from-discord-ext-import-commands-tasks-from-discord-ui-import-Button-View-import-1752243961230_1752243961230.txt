import discord
from discord.ext import commands, tasks
from discord.ui import Button, View
import asyncio
import datetime
import os
from keep_alive import keep_alive

# Webã‚µãƒ¼ãƒãƒ¼èµ·å‹•ï¼ˆReplitã®ã‚¹ãƒªãƒ¼ãƒ—é˜²æ­¢ï¼‰
keep_alive()

# Botã®Intentè¨­å®š
intents = discord.Intents.default()
intents.message_content = True
intents.members = True
intents.guilds = True
intents.voice_states = True

# Botã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ä½œæˆ
bot = commands.Bot(command_prefix="!", intents=intents)

# --- å¤‰æ›´ã—ã¦ãã ã•ã„ ---
CONFIRM_CHANNEL_ID = 1393019247864713226  # è„±é€€ãƒ¡ãƒ³ãƒãƒ¼æ¤œçŸ¥ç”¨ãƒãƒ£ãƒ³ãƒãƒ«ID
BUMP_CHANNEL_ID = 1389328686192263238  # /bumpé€šçŸ¥ãƒãƒ£ãƒ³ãƒãƒ«ID
VC_CHANNEL_ID = 1386201663446057102  # VCãƒãƒ£ãƒ³ãƒãƒ«ID
CATEGORY_ID = 1386195396480729159  # ä½œæˆå…ˆã‚«ãƒ†ã‚´ãƒªID

pending_deletions = {}


@bot.event
async def on_ready():
    print(f"âœ… Botãƒ­ã‚°ã‚¤ãƒ³å®Œäº†: {bot.user}")
    scan_threads.start()
    bump_reminder.start()


# è„±é€€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¹ãƒ¬ãƒƒãƒ‰ç¢ºèªï¼ˆ10åˆ†ãŠãï¼‰
@tasks.loop(minutes=10)
async def scan_threads():
    for guild in bot.guilds:
        for channel in guild.channels:
            if isinstance(channel, discord.ForumChannel):
                for thread in channel.threads:
                    if thread.owner_id and not guild.get_member(
                            thread.owner_id):
                        confirm_channel = guild.get_channel(CONFIRM_CHANNEL_ID)
                        if confirm_channel:
                            embed = discord.Embed(
                                title="ğŸ” è„±é€€ãƒ¡ãƒ³ãƒãƒ¼ã®ãƒ•ã‚©ãƒ¼ãƒ©ãƒ æŠ•ç¨¿ã‚’æ¤œå‡º",
                                description=f"ã‚¹ãƒ¬ãƒƒãƒ‰: `{thread.name}`",
                                color=discord.Color.orange())
                            embed.add_field(name="ä½œæˆè€…ID",
                                            value=str(thread.owner_id),
                                            inline=False)
                            embed.add_field(name="ã‚¹ãƒ¬ãƒƒãƒ‰ID",
                                            value=str(thread.id),
                                            inline=False)
                            embed.add_field(name="ç¢ºèªæ–¹æ³•",
                                            value="âœ…ã§å‰Šé™¤ã€âŒã§ã‚¹ã‚­ãƒƒãƒ—",
                                            inline=False)

                            msg = await confirm_channel.send(embed=embed)
                            await msg.add_reaction("âœ…")
                            await msg.add_reaction("âŒ")
                            pending_deletions[msg.id] = thread.id
                            await asyncio.sleep(1)


@bot.event
async def on_raw_reaction_add(payload):
    if payload.message_id not in pending_deletions:
        return
    if str(payload.emoji.name) not in ["âœ…", "âŒ"]:
        return

    guild = bot.get_guild(payload.guild_id)
    if guild is None:
        return
    user = guild.get_member(payload.user_id)
    if user is None or user.bot:
        return

    channel = bot.get_channel(payload.channel_id)
    msg = await channel.fetch_message(payload.message_id)
    thread_id = pending_deletions[payload.message_id]
    thread = await guild.fetch_channel(thread_id)

    if payload.emoji.name == "âœ…":
        await thread.delete(reason="ç®¡ç†è€…ã®ç¢ºèªã«ã‚ˆã‚Šå‰Šé™¤")
        await msg.reply(f"ğŸ—‘ ã‚¹ãƒ¬ãƒƒãƒ‰ `{thread.name}` ã‚’å‰Šé™¤ã—ã¾ã—ãŸ")
    elif payload.emoji.name == "âŒ":
        await msg.reply(f"â¹ ã‚¹ãƒ¬ãƒƒãƒ‰ `{thread.name}` ã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã—ãŸ")

    del pending_deletions[payload.message_id]


# /bumpé€šçŸ¥ï¼ˆ2æ™‚é–“ã”ã¨ï¼‰
@tasks.loop(hours=2)
async def bump_reminder():
    channel = bot.get_channel(BUMP_CHANNEL_ID)
    if channel:
        await channel.send("ğŸ“¢ `/bump` ã®æ™‚é–“ã§ã™ï¼å¿˜ã‚Œãšã«ãƒãƒ³ãƒ—ã—ã¦ãã ã•ã„ï¼")


# VCå‚åŠ è€…å°‚ç”¨ãƒãƒ£ãƒ³ãƒãƒ«ä½œæˆãƒœã‚¿ãƒ³
class CreatePrivateVCChannelView(View):

    @discord.ui.button(label="VCãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒ£ãƒ³ãƒãƒ«ä½œæˆ",
                       style=discord.ButtonStyle.green)
    async def create_channel(self, interaction: discord.Interaction,
                             button: Button):
        guild = interaction.guild
        vc_channel = guild.get_channel(VC_CHANNEL_ID)
        category = guild.get_channel(CATEGORY_ID)

        if not vc_channel or not category:
            await interaction.response.send_message(
                "âš  VCãƒãƒ£ãƒ³ãƒãƒ«ã¾ãŸã¯ã‚«ãƒ†ã‚´ãƒªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚", ephemeral=True)
            return

        members = vc_channel.members
        if not members:
            await interaction.response.send_message("âš  VCã«å‚åŠ ã—ã¦ã„ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ãŒã„ã¾ã›ã‚“ã€‚",
                                                    ephemeral=True)
            return

        overwrites = {
            guild.default_role:
            discord.PermissionOverwrite(read_messages=False),
            guild.me: discord.PermissionOverwrite(read_messages=True)
        }
        for member in members:
            overwrites[member] = discord.PermissionOverwrite(
                read_messages=True, send_messages=True)

        today = datetime.datetime.now().strftime("vc-%Y-%m-%d")

        channel = await guild.create_text_channel(name=today,
                                                  overwrites=overwrites,
                                                  category=category)

        await interaction.response.send_message(
            f"âœ… ãƒãƒ£ãƒ³ãƒãƒ« {channel.mention} ã‚’ä½œæˆã—ã¾ã—ãŸã€‚", ephemeral=True)


@bot.command()
async def setup(ctx):
    """VCãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒ£ãƒ³ãƒãƒ«ä½œæˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º"""
    view = CreatePrivateVCChannelView()
    await ctx.send("VCå‚åŠ ãƒ¡ãƒ³ãƒãƒ¼ã ã‘ã®ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒãƒ£ãƒ³ãƒãƒ«ã‚’ä½œæˆã—ã¾ã™ã€‚ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚", view=view)


# æœ€å¾Œã«ä¸€å›ã ã‘ bot.run()
bot.run(os.getenv("TOKEN"))

git add .
git commit -m "Pushãƒ†ã‚¹ãƒˆã®ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ "
git push origin main
